name: Maven Security Scan Daily

on:
  workflow_dispatch:
  # Trigger the workflow at 00:00:00 of Germany time (runner is UTC time, UTC+2 or UTC+1 depending on daylight saving)
  schedule:
    - cron: '0 23 * * *'

jobs:
  fetch-branches:
    name: Fetch Branches for Security Scan
    runs-on: [self-hosted]

    outputs:
      branch_matrix: ${{ steps.set_branch.outputs.branch_matrix }}

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4

      - name: Fetch all branches
        id: fetch_branches
        run: |
          git fetch --all
          BRANCHES=$(git branch -r | grep "origin/release/" | sed 's/origin\///' | sort -Vr)
          echo "RELEASE_BRANCHES=$(echo $BRANCHES | tr '\n' ' ')" >> $GITHUB_ENV

      - name: Define matrix branches
        id: set_branch
        run: |
          if [ -z "$RELEASE_BRANCHES" ]; then
            echo '["main", "develop"]' > branch_matrix.json
          else
            RELEASE_BRANCHES_JSON=$(echo $RELEASE_BRANCHES | sed 's/ /", "/g')
            echo '["main", "develop", "'$RELEASE_BRANCHES_JSON'"]' > branch_matrix.json
          fi
          cat branch_matrix.json
          echo "branch_matrix=$(cat branch_matrix.json)" >> $GITHUB_OUTPUT

      - name: Set Branch Variables
        id: set_branch_variables
        run: |
          if [[ "${{ matrix.branch }}" == "main" ]]; then
            echo "SONAR_BRANCH=main" >> $GITHUB_ENV
            echo "BLACKDUCK_PHASE=RELEASED" >> $GITHUB_ENV
            echo "BLACKDUCK_PROJECT_VERSION=RELEASED" >> $GITHUB_ENV
            echo "SECHUB_BRANCH=main" >> $GITHUB_ENV
          elif [[ "${{ matrix.branch }}" == "develop" ]]; then
            echo "SONAR_BRANCH=develop" >> $GITHUB_ENV
            echo "BLACKDUCK_PHASE=DEVELOPMENT" >> $GITHUB_ENV
            echo "BLACKDUCK_PROJECT_VERSION=DEVELOPMENT" >> $GITHUB_ENV
            echo "SECHUB_BRANCH=develop" >> $GITHUB_ENV
          elif [[ "${{ matrix.branch }}" == release/* ]]; then
            echo "SONAR_BRANCH=release" >> $GITHUB_ENV
            echo "BLACKDUCK_PHASE=PRERELEASE" >> $GITHUB_ENV
            echo "BLACKDUCK_PROJECT_VERSION=PRERELEASE" >> $GITHUB_ENV
            echo "SECHUB_BRANCH=release" >> $GITHUB_ENV
          else
            echo "SONAR_BRANCH=develop" >> $GITHUB_ENV
            echo "BLACKDUCK_PHASE=DEVELOPMENT" >> $GITHUB_ENV
            echo "BLACKDUCK_PROJECT_VERSION=DEVELOPMENT" >> $GITHUB_ENV
            echo "SECHUB_BRANCH=develop" >> $GITHUB_ENV
          fi

  security-scan-per-branch:
    needs: fetch-branches
    strategy:
      matrix:
        branch: ${{ fromJson(needs.fetch-branches.outputs.branch_matrix) }}
    runs-on: [self-hosted]
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4

      # Call the reusable workflow, referencing the environment variables set in the previous step
      - name: Maven Test with Security Scanning
        uses: sancheam/reusable-workflow/.github/workflows/maven-test-with-security-scanning.yml@main
        secrets: inherit
        with:
          git_branch: ${{ matrix.branch }}
          sonar_branch: ${{ env.SONAR_BRANCH }}
          blackduck_phase: ${{ env.BLACKDUCK_PHASE }}
          blackduck_project_version: ${{ env.BLACKDUCK_PROJECT_VERSION }}
          sechub_branch: ${{ env.SECHUB_BRANCH }}
          setup_local_database: 'true'
